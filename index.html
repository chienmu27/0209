<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>繳費查詢</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  padding: 20px;
  background: #fafafa;
}
h2 { color: #333; }

select {
  font-size: 16px;
  padding: 6px;
  margin: 10px 0;
  width: 180px;
}

#payStatus {
  margin: 6px 0 10px;
  font-size: 18px;
  font-weight: bold;
  color: red;
}

table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
  font-size: 15px;
}
th { background-color: #f0f0f0; }
</style>
</head>
<body>

<h2>繳費查詢</h2>

<label>選擇學生：</label><br>
<select id="studentSelect">
  <option value="">--請選擇--</option>
</select>

<div id="payStatus"></div>

<table id="resultTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
// ====== CSV 連結（GitHub Pages 可直接讀取）======
const csvUrl =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vS0tI5Jlr-JGfZEZ1_DBIQQ-bTZ1g1I6uggZj7J3ZhgF5wQiv1EP2HI96CbC4o6CpsFWAeVB9A2SYm7/pub?gid=0&single=true&output=csv";

let rows = [];
let header = [];

// ====== CSV 解析 ======
function parseCSV(text) {
  const result = [];
  let cur = [];
  let curVal = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (inQuotes) {
      if (ch === '"' && next === '"') {
        curVal += '"';
        i++;
      } else if (ch === '"') {
        inQuotes = false;
      } else {
        curVal += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',') {
        cur.push(curVal);
        curVal = "";
      } else if (ch === '\n') {
        cur.push(curVal);
        result.push(cur);
        cur = [];
        curVal = "";
      } else if (ch !== '\r') {
        curVal += ch;
      }
    }
  }
  if (curVal !== "" || cur.length > 0) {
    cur.push(curVal);
    result.push(cur);
  }
  return result;
}

// ====== 載入 CSV ======
async function loadCSV() {
  const res = await fetch(csvUrl);
  const text = await res.text();
  const parsed = parseCSV(text);

  rows = parsed.filter(r => r.some(c => c && String(c).trim() !== ""));
  header = rows[0];

  buildStudentDropdown();
}

// ====== 建立學生選單（改為 A2:A） ======
function buildStudentDropdown() {
  const set = new Set();

  // A欄 = index 0，從第2列開始
  rows.slice(1).forEach(r => {
    const name = String(r[0] ?? "").trim();
    if (name) set.add(name);
  });

  const select = document.getElementById("studentSelect");
  select.innerHTML = '<option value="">--請選擇--</option>';

  [...set].sort().forEach(name => {
    const op = document.createElement("option");
    op.value = name;
    op.textContent = name;
    select.appendChild(op);
  });
}

// ====== 篩選學生資料（依欄位名稱：姓名） ======
function filterData(studentName) {
  const idxName = header.indexOf("姓名");
  if (idxName === -1) return [];
  return rows.slice(1).filter(r => String(r[idxName] ?? "").trim() === studentName);
}

// ====== 繳費狀態判斷 ======
function renderPayStatus(data) {
  const statusDiv = document.getElementById("payStatus");
  statusDiv.textContent = "";

  const payIdx = header.indexOf("繳費情況");
  if (payIdx === -1) return;

  const hasPaid = data.some(r => String(r[payIdx] ?? "").trim() === "已繳費");
  statusDiv.textContent = hasPaid ? "已繳費" : "未繳費";
}

// ====== 顯示表格（姓名、項目、繳費情況） ======
function renderTable(data) {
  const thead = document.querySelector("#resultTable thead");
  const tbody = document.querySelector("#resultTable tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">沒有找到資料</td></tr>`;
    return;
  }

  const idxName = header.indexOf("姓名");
  const idxType = header.indexOf("類別");     // 顯示為「項目」
  const idxPay  = header.indexOf("繳費情況");

  thead.innerHTML = `
    <tr>
      <th>姓名</th>
      <th>項目</th>
      <th>繳費情況</th>
    </tr>
  `;

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r[idxName] ?? ""}</td>
      <td>${r[idxType] ?? ""}</td>
      <td>${r[idxPay] ?? ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ====== 下拉選單監聽 ======
document.getElementById("studentSelect").addEventListener("change", e => {
  const student = e.target.value;
  const data = filterData(student);

  renderPayStatus(data);
  renderTable(data);
});

// ====== 初始化 ======
loadCSV();
</script>

</body>
</html>
